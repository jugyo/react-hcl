# react-hcl フィードバック対応方針（実装前）

## 目的
評価レポートで指摘された 3 点（配列内 `block()`、`raw()` 出力、`metric_query` のブロック判定）を、
既存の単純ケースを壊さずに段階的に解消するための実装方針を定義する。

## 対応方針サマリー

1. **シリアライザの責務整理を先行**
   - `hcl-serializer.ts` の値シリアライズ処理で、
     - スカラー
     - オブジェクト
     - `BlockHCL`
     - `RawHCL`
     - 配列（上記の混在）
     を明示的に分岐する。
2. **配列内 `BlockHCL` を第一級サポート**
   - 配列に `BlockHCL` が含まれる場合は `key = [...]` 形式ではなく、
     同一キーの繰り返しブロックとして出力する。
3. **`raw()` の文脈依存レンダリング**
   - 代入値・配列要素・文字列補間の文脈を判定し、不要な `${}` を除去。
4. **ブロック判定ルールを拡張**
   - `metric_query` をブロック扱い対象に追加。
5. **回帰テストを先に整備し、段階的にグリーン化**
   - 失敗ケースを固定化してから実装し、既存テストの互換性を確認する。

---

## 問題別の詳細方針

### 1) 配列内 `block()` 未サポート

### 期待仕様
- 入力が `metric_query={[block(...), block(...)]}` のような場合、
  `metric_query = [...]` ではなく `metric_query { ... }` の繰り返しとして出力する。
- `ingress` / `egress` など同種の繰り返しブロックでも同様に動作する。

### 実装アプローチ
- `serializeAttribute` 相当の処理で、`Array` を検出したら要素型を走査する。
- 要素がすべて `BlockHCL` の場合:
  - 配列を「ブロック列」として扱い、各要素を同名ブロックとして改行出力。
- 要素がスカラー/Raw の場合:
  - 従来通り `[...]` の属性配列として出力。
- **混在配列（Block と非Block混在）** はエラーにするか、明示的に非対応として例外化する（曖昧仕様を避ける）。

### 互換性方針
- 既存の「純スカラー配列」出力は変更しない。
- 既存の単一 `block()` の挙動も維持する。

---

### 2) `raw()` 出力が不正

### 期待仕様
- `alarm_actions={[raw('local.sns_topic_arn')]}` → `alarm_actions = [local.sns_topic_arn]`
- 既存で必要なケース（例: 明示的なテンプレート文字列）を壊さない。

### 実装アプローチ
- `RawHCL` に「そのまま出す」責務を集約し、
  serializer 側では **文脈に応じてラップしない** 方針にする。
- `${...}` の自動付与ロジックがある場合は撤去し、
  必要なら呼び出し側が `raw('"${...}"')` のように明示指定する設計に寄せる。
- 少なくとも配列文脈では `${}` 非付与を保証する。

### 互換性方針
- 既存利用箇所を grep し、`${}` 自動付与前提のケースがないか確認してから変更。

---

### 3) `metric_query` のブロック判定不足

### 期待仕様
- `metric_query` が Terraform 的にネストブロックとして扱われる。

### 実装アプローチ
- ブロック判定ホワイトリスト（`BLOCK_WHITELIST` 相当）に `metric_query` を追加。
- 将来拡張として、固定 whitelist 依存を減らすために「値が BlockHCL ならブロック」とする推論型ルールを検討。

---

## 実装順（推奨）

1. **テスト追加（赤）**
   - `block()` 配列の再現テスト
   - `raw()` 配列文脈の再現テスト
   - `metric_query` ブロック出力テスト
2. **serializer の配列分岐改修**
3. **`raw()` のレンダリング改修**
4. **`metric_query` ルール追加**
5. **fmt/validate 相当テストで最終確認**

---

## テスト計画（実装時に追加）

- 単体テスト（`tests/hcl-serializer.test.ts` 近辺）
  - 配列が Block のみ → 繰り返しブロック
  - 配列が Raw/文字列のみ → 属性配列
  - 配列混在 → エラー（または仕様化した挙動）
- スナップショット/統合テスト
  - CloudWatch Metric Alarm の実例（`metric_query` + `alarm_actions`）
- 可能なら CI で `terraform fmt -check` / `terraform validate` をサンプルに対して実行

---

## リスクと緩和策

- **リスク**: 配列判定の変更で既存リソースの出力が変わる
  - **緩和**: 既存テスト全件実行 + 影響範囲をテスト追加で固定
- **リスク**: `raw()` の解釈変更で後方互換性が崩れる
  - **緩和**: 既存 `raw(` 使用箇所の棚卸し、必要なら移行ガイドを README に追記
- **リスク**: whitelist 追加の都度メンテが必要
  - **緩和**: 中長期で推論型ルールへ寄せる設計メモを残す

---

## 受け入れ基準（Definition of Done）

- レポートの再現ケースで `terraform fmt` が通る。
- `metric_query` と `alarm_actions` を含むサンプルで期待 HCL を生成できる。
- 既存テストがすべてグリーン。
- 仕様差分（特に `raw()`）が README または設計ドキュメントに明文化されている。
